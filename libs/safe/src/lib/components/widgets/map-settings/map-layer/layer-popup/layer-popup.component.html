<div class="flex flex-col">
  {{ 'components.widget.settings.map.layers.popup.popup' | translate }}
  <div [formGroup]="formGroup">
    <div class="flex flex-col">
      <mat-form-field appearance="outline">
        <mat-label>{{
          'components.widget.settings.map.layers.popup.title' | translate
        }}</mat-label>
        <safe-editor-control
          formControlName="title"
          [editorConfig]="editorConfig"
        ></safe-editor-control>
        <safe-icon
          icon="info"
          class="cursor-pointer"
          variant="grey"
          matSuffix
          [matTooltip]="
            'components.widget.settings.map.layers.popup.tooltip.text'
              | translate
          "
        ></safe-icon>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>{{
          'components.widget.settings.map.layers.popup.description' | translate
        }}</mat-label>
        <safe-editor-control
          formControlName="description"
          [editorConfig]="editorConfig"
        ></safe-editor-control>
        <safe-icon
          icon="info"
          class="cursor-pointer"
          variant="grey"
          matSuffix
          [matTooltip]="
            'components.widget.settings.map.layers.popup.tooltip.text'
              | translate
          "
        ></safe-icon>
      </mat-form-field>
    </div>
    <safe-divider></safe-divider>
    <h3>
      {{
        'components.widget.settings.map.layers.popup.popupElements' | translate
      }}
    </h3>
    <div
      formArrayName="popupElements"
      cdkDropList
      (cdkDropListDropped)="onListDrop($event)"
    >
      <mat-expansion-panel
        [expanded]="false"
        hideToggle
        cdkDrag
        *ngFor="let item of popupElements.controls; let index = index"
        [formGroup]="$any(item)"
      >
        <!-- Expand block header -->
        <mat-expansion-panel-header class="flex">
          <mat-panel-title class="grow-0">
            <safe-button
              cdkDragHandle
              [isIcon]="true"
              icon="drag_indicator"
            ></safe-button>
          </mat-panel-title>
          <mat-panel-description>
            <div class="flex flex-col">
              <h4 class="!m-0">
                {{ item.value.type }}
              </h4>
              <h6 class="!m-0">{{ item.value.title }}</h6>
            </div>
          </mat-panel-description>
          <safe-button
            [isIcon]="true"
            icon="close"
            (click)="onRemoveElement(index)"
          ></safe-button>
        </mat-expansion-panel-header>
        <!-- Expanded block content -->
        <div class="flex flex-col mx-4">
          <safe-fields-element
            *ngIf="item.value.type === 'fields'"
            [formGroup]="$any(item)"
            [fields$]="fields$"
          ></safe-fields-element>
          <safe-text-element
            *ngIf="item.value.type === 'text'"
            [formGroup]="$any(item)"
            [fields$]="fields$"
          ></safe-text-element>
        </div>
      </mat-expansion-panel>
    </div>
    <!-- Add new block -->
    <safe-button
      category="secondary"
      variant="primary"
      [matMenuTriggerFor]="contentOptions"
      class="self-center mt-4"
    >
      {{ 'components.widget.settings.map.layers.popup.addField' | translate }}
    </safe-button>
    <mat-menu #contentOptions="matMenu">
      <a mat-menu-item (click)="onAddElement('fields')">
        {{ 'components.widget.settings.map.layers.popup.fields' | translate }}
      </a>
      <a mat-menu-item (click)="onAddElement('text')">
        {{ 'components.widget.settings.map.layers.popup.text' | translate }}
      </a>
    </mat-menu>
  </div>
</div>
