<mat-spinner diameter="45" class="page-loader" *ngIf="loading"></mat-spinner>
<ng-container *ngIf="!loading && referenceData">
    <div class="page-header">
        <safe-previous-button path="/referencedata"></safe-previous-button>
            <h1 class="page-title">
                {{referenceData?.name}}
            </h1>
        <safe-access [access]="referenceData?.permissions" (save)="saveAccess($event)" *ngIf="referenceData?.canUpdate"></safe-access>
    </div>
    <div mat-dialog-content>
        <form [formGroup]="referenceForm">
            <div style="display: flex">
                <!-- Name -->
                <mat-form-field appearance="outline" style="flex:2">
                    <mat-label>{{'global.name' | translate}}</mat-label>
                    <input matInput formControlName="name" type="text" [placeholder]="'global.namePlaceholder' | translate"/>
                    <mat-error *ngIf="name?.errors">
                        {{'referenceData.warning' | translate}}
                    </mat-error>
                </mat-form-field>
                <!-- Type selection -->
                <mat-form-field appearance="outline">
                    <mat-label>{{ 'global.type' | translate }}</mat-label>
                    <mat-select formControlName="type">
                        <mat-option *ngFor="let referenceTypeChoice of referenceTypeChoices" [value]=referenceTypeChoice>{{ referenceTypeChoice }}</mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <!-- Specific to GraphQL and Rest type -->
            <div *ngIf="['rest', 'graphql'].includes(type)">
                <div style="display: flex">
                    <!-- API Configuration -->
                    <mat-form-field appearance="outline" style="flex:2">
                        <mat-label>{{ 'referenceData.apiConfiguration' | translate }}</mat-label>
                        <mat-select #apiConfSelect formControlName="apiConfiguration" (openedChange)="onOpenSelect($event)">
                            <mat-option *ngFor="let apiConf of apiConfigurations$ | async" [value]="apiConf.id">{{ apiConf.name }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <!-- QueryName -->
                    <mat-form-field appearance="outline" style="flex:3">
                        <mat-label>{{'referenceData.queryName' | translate}}</mat-label>
                        <input matInput formControlName="query" type="text" [placeholder]="'global.queryNamePlaceholder' | translate"/>
                    </mat-form-field>
                </div>
                <!-- Fields -->
                <div style="display: flex">
                    <mat-form-field class="chip-list" appearance="outline" style="flex:2">
                        <mat-label>{{ 'referenceData.fields' | translate }}</mat-label>
                        <mat-chip-list #chipList aria-label="Fields chip list">
                        <mat-chip
                            *ngFor="let field of valueFields"
                            [selectable]="true"
                            [removable]="true"
                            (removed)="remove(field)">
                            {{ field }}
                            <safe-icon matChipRemove icon="cancel" [size]="18"></safe-icon>
                        </mat-chip>
                        <input
                            #fieldInput
                            [matChipInputFor]="chipList"
                            [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                            (focusout)="add($event)"
                            (matChipInputTokenEnd)="add($event)"
                        />
                        </mat-chip-list>
                    </mat-form-field>
                </div>
            </div>
            <!-- CSV Input for static type -->
            <div *ngIf="type === 'static'" class="csv-input">
                <mat-form-field appearance="outline">
                    <mat-label>{{ 'referenceData.csv' | translate }}</mat-label>
                    <textarea #csvData matInput [placeholder]="'referenceData.csvPlaceholder' | translate" [value]="csvValue"></textarea>
                </mat-form-field>
                <safe-button category="secondary" variant="primary" (click)="onValidateCSV()">
                    {{'referenceData.saveCSV' | translate}}
                </safe-button>
            </div>
            <div style="display: flex">
                <!-- Path -->
                <mat-form-field  style="flex:3" appearance="outline" *ngIf="['rest', 'graphql'].includes(type)">
                    <mat-label>{{'referenceData.path' | translate}}</mat-label>
                    <input matInput formControlName="path" type="text" [placeholder]="'global.queryNamePlaceholder' | translate"/>
                </mat-form-field>
                <!-- Value field to be displayed -->
                <mat-form-field style="flex:2" appearance="outline" *ngIf="type && valueFields.length > 0">
                    <mat-label>{{ 'referenceData.valueField' | translate }}</mat-label>
                    <mat-select formControlName="valueField">
                        <mat-option *ngFor="let value of valueFields" [value]="value">{{ value }}</mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <!-- Kendo grid to preview data on static type -->
            <div *ngIf="csvValue && type === 'static'">
                <kendo-grid [data]="newData">
                    <kendo-grid-column *ngFor="let field of valueFields" [field]="field">{{ field }}</kendo-grid-column>
                </kendo-grid>
            </div>
            <safe-button category="secondary" variant="primary" (click)="onSave()" [disabled]="referenceForm.invalid || !referenceForm.dirty">
                {{'action.save' | translate}}
            </safe-button>
        </form>
    </div>
</ng-container>
