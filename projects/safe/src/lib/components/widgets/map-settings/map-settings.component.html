<ng-container *ngIf="tileForm">
  <form [formGroup]="tileForm">
    <mat-tab-group mat-align-tabs="start" animationDuration="0ms" vertical>
      <mat-tab>
        <ng-template mat-tab-label>
          <safe-icon icon="preview" [size]="24"></safe-icon>
          <span>{{ 'common.general' | translate }}</span>
        </ng-template>
        <div class="form-group">
          <h2>{{ 'common.general' | translate }}</h2>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'common.name' | translate }}</mat-label>
            <input matInput formControlName="title" type="string" />
          </mat-form-field>
        </div>
        <div class="form-group">
          <h2>{{ 'components.widget.settings.map.dataset' | translate }}</h2>
          <safe-query-builder
            [form]="$any(tileForm.controls.query)"
            [canExpand]="false"
            [showStyle]="false"
          ></safe-query-builder>
        </div>
      </mat-tab>
      <mat-tab [label]="'Layers'">
        <!-- === LAYERS CONFIGURATION === -->
        <ng-template mat-tab-label>
          <safe-icon icon="layers" [size]="24"></safe-icon>
          <span>{{ 'common.layers' | translate }}</span>
        </ng-template>
        <div class="form-group">
          <h2>{{ 'common.layers' | translate }}</h2>
          <mat-tab-group mat-align-tabs="start" animationDuration="0ms">
            <!-- === MARKERS === -->
            <mat-tab
              [label]="
                'components.widget.settings.map.layers.point.title' | translate
              "
            >
              <div class="info-text">
                {{
                  'components.widget.settings.map.layers.point.info' | translate
                }}
              </div>
              <mat-form-field appearance="outline" style="width: 100%">
                <mat-label>{{
                  'models.widget.map.latitude' | translate
                }}</mat-label>
                <mat-select formControlName="latitude">
                  <mat-option
                    *ngFor="let field of selectedFields"
                    [value]="field"
                  >
                    {{ field }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="outline" style="width: 100%">
                <mat-label>{{
                  'models.widget.map.longitude' | translate
                }}</mat-label>
                <mat-select formControlName="longitude">
                  <mat-option
                    *ngFor="let field of selectedFields"
                    [value]="field"
                  >
                    {{ field }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <mat-form-field
                appearance="outline"
                style="width: 100%"
                class="margin-bottom"
              >
                <mat-label>{{
                  'components.widget.settings.map.layers.point.category'
                    | translate
                }}</mat-label>
                <mat-select formControlName="category">
                  <mat-option [value]="">{{
                    'common.input.none' | translate
                  }}</mat-option>
                  <mat-option
                    *ngFor="let field of selectedFields"
                    [value]="field"
                  >
                    {{ field }}
                  </mat-option>
                </mat-select>
                <mat-hint
                  >{{
                    'components.widget.settings.map.tooltip.category'
                      | translate
                  }}<safe-icon
                    icon="layers"
                    [inline]="true"
                    [size]="14"
                  ></safe-icon
                ></mat-hint>
              </mat-form-field>
              <mat-label>
                {{
                  'components.widget.settings.map.layers.point.rules'
                    | translate
                }}
              </mat-label>
              <div class="info-text">
                {{
                  'components.widget.settings.map.layers.point.rulesInfo'
                    | translate
                }}
              </div>
              <div
                class="filter-list"
                *ngFor="let rule of markerRules.controls; let i = index"
                [formGroup]="$any(rule)"
              >
                <div>
                  <mat-form-field appearance="outline">
                    <mat-label>{{ 'common.label' | translate }}</mat-label>
                    <input type="text" matInput formControlName="label" />
                  </mat-form-field>
                  <div class="deleteBtn">
                    <safe-button
                      [isIcon]="true"
                      icon="delete"
                      category="primary"
                      variant="danger"
                      (click)="removeMarkerRule(i)"
                    ></safe-button>
                  </div>
                </div>
                <mat-form-field appearance="outline">
                  <mat-label>{{
                    'components.widget.settings.map.layers.point.size'
                      | translate
                  }}</mat-label>
                  <input
                    type="number"
                    matInput
                    formControlName="size"
                    min="1"
                    max="10"
                  />
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>{{
                    'components.widget.settings.map.layers.point.color'
                      | translate
                  }}</mat-label>
                  <h4></h4>
                  <input type="color" matInput formControlName="color" />
                </mat-form-field>
                <safe-tab-filter
                  [form]="$any(rule).controls.filter"
                  [fields]="formatedSelectedFields"
                ></safe-tab-filter>
              </div>
              <safe-button
                type="button"
                category="tertiary"
                variant="primary"
                (click)="addMarkerRule()"
                >{{
                  'components.widget.settings.map.layers.point.addNew'
                    | translate
                }}</safe-button
              >
            </mat-tab>

            <!-- === CLOROPHLETS === -->
            <mat-tab
              [label]="
                'components.widget.settings.map.layers.clorophlet.title'
                  | translate
              "
            >
              <div class="info-text">
                {{
                  'components.widget.settings.map.layers.clorophlet.info'
                    | translate
                }}
              </div>
              <div
                class="filter-list"
                *ngFor="let clorophlet of clorophlets.controls; let i = index"
                [formGroup]="$any(clorophlet)"
              >
                <div>
                  <mat-form-field appearance="outline">
                    <mat-label>{{ 'common.name' | translate }}</mat-label>
                    <input
                      type="text"
                      [placeholder]="'common.placeholder.name' | translate"
                      matInput
                      formControlName="name"
                    />
                  </mat-form-field>
                  <div class="deleteBtn">
                    <safe-button
                      [isIcon]="true"
                      icon="delete"
                      category="primary"
                      variant="danger"
                      (click)="removeClorophlet(i)"
                    ></safe-button>
                  </div>
                </div>
                <div class="filter-buttons">
                  <safe-button category="tertiary" (click)="fileInput.click()">{{
                    clorophlet.value.geoJSONname
                      ? clorophlet.value.geoJSONname
                      : ('common.uploadObject'
                        | translate
                          : {
                              name:
                                ('components.widget.settings.map.layers.clorophlet.geoJSON'
                                | translate)
                            })
                  }}</safe-button>
                  <input
                    hidden
                    #fileInput
                    type="file"
                    id="file{{ i }}"
                    accept=".json, .geojson"
                    (change)="uploadGeoJSON(i)"
                  />
                </div>
                <div>
                  <mat-form-field appearance="outline">
                    <mat-label>{{
                      'components.widget.settings.map.layers.clorophlet.identifier'
                        | translate
                    }}</mat-label>
                    <mat-select formControlName="place">
                      <mat-option
                        *ngFor="let field of selectedFields"
                        [value]="field"
                        >{{ field }}</mat-option
                      >
                    </mat-select>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="extraInput">
                    <mat-label>{{
                      'components.widget.settings.map.layers.clorophlet.geoJSONidentifier'
                        | translate
                    }}</mat-label>
                    <mat-select formControlName="geoJSONfield">
                      <mat-option
                        *ngFor="let field of geoJSONfields[i]"
                        [value]="field"
                        >{{ field }}</mat-option
                      >
                    </mat-select>
                  </mat-form-field>
                </div>
                <mat-label>Opacity</mat-label>
                <mat-slider
                  thumbLabel
                  tickInterval="1"
                  formControlName="opacity"
                  [min]="0"
                  [max]="100"
                ></mat-slider>
                <div>
                  <div
                    *ngFor="
                      let division of $any(clorophlet.get('divisions'))
                        .controls;
                      let f = index
                    "
                    class="filter-list"
                    [formGroup]="division"
                  >
                    <div>
                      <mat-form-field appearance="outline">
                        <mat-label>{{ 'common.label' | translate }}</mat-label>
                        <input type="text" matInput formControlName="label" />
                      </mat-form-field>
                      <div class="deleteBtn">
                        <safe-button
                          [isIcon]="true"
                          icon="delete"
                          category="primary"
                          variant="danger"
                          (click)="removeDivision(clorophlet, f)"
                        ></safe-button>
                      </div>
                    </div>
                    <mat-form-field appearance="outline">
                      <mat-label>{{
                        'components.widget.settings.map.layers.point.color'
                          | translate
                      }}</mat-label>
                      <h4></h4>
                      <input type="color" matInput formControlName="color" />
                    </mat-form-field>
                    <safe-tab-filter
                      [form]="division.controls.filter"
                      [fields]="formatedSelectedFields"
                    ></safe-tab-filter>
                  </div>
                  <div>
                    <safe-button
                      category="tertiary"
                      variant="primary"
                      (click)="addDivision(clorophlet)"
                      >{{
                        'components.widget.settings.map.layers.clorophlet.addNewDiv'
                          | translate
                      }}</safe-button
                    >
                  </div>
                </div>
              </div>
              <safe-button
                category="tertiary"
                variant="primary"
                (click)="addClorophlet()"
                >{{
                  'components.widget.settings.map.layers.clorophlet.addNew'
                    | translate
                }}</safe-button
              >
            </mat-tab>

            <!-- === ONLINE LAYERS === -->
            <mat-tab
              [label]="
                'components.widget.settings.map.layers.online.title' | translate
              "
            >
              <div class="info-text">
                {{
                  'components.widget.settings.map.layers.online.info'
                    | translate
                }}
              </div>
              <mat-form-field appearance="outline" style="width: 100%">
                <mat-label>{{
                  'components.widget.settings.map.layers.online.select'
                    | translate
                }}</mat-label>
                <input
                  type="text"
                  matInput
                  [(ngModel)]="search"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="getContent($event)"
                  autocomplete="off"
                  placeholder="{{ 'common.placeholder.search' | translate }}"
                />
                <div *ngIf="availableLayers.length > 0" class="layer-list">
                  <button
                    *ngFor="let layer of availableLayers"
                    mat-button
                    (click)="addOnlineLayer(layer)"
                  >
                    {{ layer.title }}
                    <safe-badge *ngFor="let tag of layer.tags">{{
                      tag
                    }}</safe-badge>
                  </button>
                </div>
              </mat-form-field>
              <mat-label
                *ngIf="
                  tileForm.value.onlineLayers &&
                  tileForm.value.onlineLayers.length > 0
                "
              >
                {{
                  'components.widget.settings.map.layers.online.selected'
                    | translate
                }}
              </mat-label>
              <h3 *ngFor="let layer of tileForm.value.onlineLayers">
                {{ layer.title }}
                <safe-button
                  [isIcon]="true"
                  icon="delete"
                  category="primary"
                  variant="danger"
                  (click)="removeOnlineLayer(layer.id)"
                ></safe-button>
              </h3>
            </mat-tab>
          </mat-tab-group>
        </div>
      </mat-tab>
      <mat-tab>
        <!-- === DEFAULT PARAMETERS === -->
        <ng-template mat-tab-label>
          <safe-icon icon="map" [size]="24"></safe-icon>
          <span>{{
            'components.widget.settings.map.display.title' | translate
          }}</span>
        </ng-template>
        <div class="form-group">
          <h2>
            {{ 'components.widget.settings.map.display.title' | translate }}
          </h2>
          <mat-form-field appearance="outline">
            <mat-label>{{
              'components.widget.settings.map.display.basemap' | translate
            }}</mat-label>
            <mat-select formControlName="basemap" placeholder="OSM">
              <mat-option *ngFor="let map of basemaps" [value]="map">
                {{ map }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-label>
            {{ 'components.widget.settings.map.display.zoom' | translate }}
            <safe-icon
              icon="info"
              [matTooltip]="
                'components.widget.settings.map.display.latitude' | translate
              "
              [inline]="true"
              [size]="16"
              variant="grey"
            ></safe-icon>
          </mat-label>
          <mat-slider
            thumbLabel
            tickInterval="1"
            formControlName="zoom"
            [min]="0"
            [max]="10"
          ></mat-slider>
          <div class="map-default-settings">
            <mat-form-field appearance="outline">
              <mat-label>
                {{
                  'components.widget.settings.map.display.latitude' | translate
                }}
              </mat-label>
              <input type="number" matInput formControlName="centerLat" />
              <safe-icon
                matSuffix
                icon="info"
                variant="grey"
                [matTooltip]="
                  'components.widget.settings.map.tooltip.default.latitude'
                    | translate
                "
              ></safe-icon>
              <mat-error *ngIf="tileForm.controls.centerLat.errors">
                {{
                  'components.widget.settings.map.errors.latitude' | translate
                }}
              </mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>
                {{
                  'components.widget.settings.map.display.longitude' | translate
                }}
              </mat-label>
              <input type="number" matInput formControlName="centerLong" />
              <safe-icon
                matSuffix
                icon="info"
                variant="grey"
                [matTooltip]="
                  'components.widget.settings.map.tooltip.default.longitude'
                    | translate
                "
              ></safe-icon>
              <mat-error *ngIf="tileForm.controls.centerLat.errors">
                {{
                  'components.widget.settings.map.errors.longitude' | translate
                }}
              </mat-error>
            </mat-form-field>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </form>
</ng-container>
